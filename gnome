#!/usr/bin/env bash

# Instalación del entorno de escritorio Gnome 4.1.x minimal
# Repositorio: https://github.com/mxhectorvega/installarch
# Ejecución: bash <(curl -L is.gd/mxignome) o tinyurl.com/mxgnome
# Fecha de actualización: 07/02/2025
# Versión: 7.4

# Nota: El sistema debe haberse instalado preferentemente con la herramienta ArchInstall desde ArchISO seleccionando el perfil minimal (sin entorno de escritorio).

# Actualizar y sincronizar repositorios
sudo pacman -Sy --noconfirm

# Instalar paquetes esenciales para el sistema operativo
# "seahorse"
paquetes_esenciales=(
    "openssh"
    "acpi"
    "plocate"
    "usbutils"
    "ntfs-3g"
    "dosfstools"
    "pacman-contrib"
    "fuse"
    "xdg-user-dirs"
    "rsync"
    "nano"
    "udisks2"
    "parted"
    "btrfs-progs"
    "lvm2"
    "xfsprogs"
    "dosfstools"
    "lm_sensors"
    "hddtemp"
    "apcupsd"
    "smartmontools"
    "amd-ucode"
    "intel-ucode"
    "mesa"
    "flatpak"
    "android-tools"
    "scrcpy"
)

sudo pacman -S "${paquetes_esenciales[@]}" --noconfirm --needed

# Instalar herramientas de terminal
herramientas_terminal=(
    "fastfetch"
    "git"
    "curl"
    "wget"
    "htop"
    "radeontop"
    "powertop"
    "vim"
    "less"
    "nmap"
    "speedtest-cli"
)

sudo pacman -S "${herramientas_terminal[@]}" --noconfirm --needed

# Instalar paquetes mínimos para que Gnome funcione
paquetes_gnome=(
    "gdm"
    "gnome-shell"
    "nautilus"
    "gnome-control-center"
    "gnome-console"
    "gnome-disk-utility"
    "polkit-gnome"
    "xdg-desktop-portal"
    "xdg-desktop-portal-gnome"
    "power-profiles-daemon"
)

sudo pacman -S "${paquetes_gnome[@]}" --noconfirm --needed

# Crear directorios de usuario en español
xdg-user-dirs-update

# Crear enlace simbólico para el paquete ssh-askpass
#sudo ln -s /usr/lib/seahorse/ssh-askpass /usr/lib/ssh/ssh-askpass

# Configurar ZRAM
sudo tee -a /etc/systemd/zram-generator.conf <<EOF
zram-size = ram
compression-algorithm = zstd
EOF

# Crear directorios de fuentes antes de clonar los repositorios
mkdir -p "$HOME/.local/share/fonts/tipografias"
mkdir -p "$HOME/.local/share/fonts/tipografiaswin"

# Clonar repositorios directamente en los directorios creados
git clone https://github.com/mxhectorvega/tipografias "$HOME/.local/share/fonts/tipografias"
git clone https://github.com/mxhectorvega/tipografiaswin "$HOME/.local/share/fonts/tipografiaswin"

# Limpiar archivos .git y .md
find "$HOME/.local/share/fonts/" -name ".git" -exec rm -rf {} +
find "$HOME/.local/share/fonts/" -name "*.md" -exec rm -f {} +

# Instalar y configurar el controlador de Bluetooth
sudo pacman -S bluez bluez-utils --needed --noconfirm
sudo systemctl enable --now bluetooth.service

# Instalar Java (por si acaso se requiere)
sudo pacman -S jre8-openjdk --noconfirm --needed

# Instalar Adw GTK en ~/.local/share/themes
mkdir -p ~/.local/share/themes && curl -sL $(curl -s https://api.github.com/repos/lassekongo83/adw-gtk3/releases/latest | grep "browser_download_url" | grep -Eo "https://[^\"]+.tar.(xz|zx|gz)") -o /tmp/adw-gtk3.tar && tar -xf /tmp/adw-gtk3.tar -C ~/.local/share/themes && rm /tmp/adw-gtk3.tar

# Instalar Adw GTK en flatpak
flatpak install --user -y org.gtk.Gtk3theme.adw-gtk3 org.gtk.Gtk3theme.adw-gtk3-dark

# Definir temas previamente descargado e instalados para flatpak apps
sudo flatpak override --filesystem=xdg-data/themes

# Definir el tema dark de Adwk GTK global
gsettings set org.gnome.desktop.interface gtk-theme 'adw-gtk3-dark' && gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'

# Activar el servicio de pantalla de inicio de sesión (GDM)
for i in {1..8}; do
    clear
    printf 'Activando display manager'$(printf '.%.0s' $(seq 1 $i))
    sleep 0.1
done

gsettings set org.gnome.desktop.interface enable-animations false

sudo systemctl enable --now power-profiles-daemon
sudo systemctl enable --now gdm
