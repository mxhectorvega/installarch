#!/usr/bin/env bash

# Verificar que el script se ejecuta como root
if [ "$(id -u)" -ne 0 ]; then
    echo "Por favor, ejecuta este script como root."
    exit 1
fi

echo "Actualizando repositorios e instalando paquetes necesarios..."
pacman -Syu --needed qemu-base libvirt virt-viewer dnsmasq vde2 bridge-utils openbsd-netcat ebtables iptables edk2-ovmf usbredir spice-vdagent xf86-video-qxl mesa libdrm

echo "Configurando y habilitando servicios de libvirt..."
systemctl enable --now libvirtd.service || {
    echo "Error al habilitar libvirt. Verifica el servicio manualmente."
    exit 1
}

echo "Configurando acceso sin contraseñas para libvirt..."
mkdir -p /etc/libvirt/qemu/networks
cat <<EOF > /etc/libvirt/libvirtd.conf
unix_sock_group = "libvirt"
unix_sock_rw_perms = "0770"
EOF
systemctl restart libvirtd.service

echo "Configurando red NAT personalizada..."
cat <<EOF > /etc/libvirt/qemu/networks/default.xml
<network>
  <name>default</name>
  <uuid>$(uuidgen)</uuid>
  <forward mode='nat'/>
  <bridge name='virbr0' stp='on' delay='0'/>
  <ip address='192.168.3.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.3.100' end='192.168.3.200'/>
    </dhcp>
  </ip>
</network>
EOF

echo "Aplicando configuración de red virtual 'default'..."
virsh net-destroy default || true
virsh net-undefine default || true
if virsh net-define /etc/libvirt/qemu/networks/default.xml; then
    echo "Red definida correctamente."
else
    echo "Error al definir la red virtual. Verifica el archivo default.xml."
    exit 1
fi

if virsh net-start default; then
    echo "Red iniciada correctamente."
else
    echo "Error al iniciar la red. Revisa los registros de libvirt."
    exit 1
fi

virsh net-autostart default

echo "Verificando configuración final..."
if virsh net-info default &>/dev/null; then
    echo "La red 'default' está configurada y activa."
else
    echo "Error: La red 'default' no está activa. Revisa manualmente."
    exit 1
fi

echo "Script finalizado. Reinicia la sesión para aplicar los cambios."
