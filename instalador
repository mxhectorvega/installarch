#!/usr/bin/env bash

# Solicitar la contrase√±a al inicio con puntos por cada car√°cter
mostrar_contrasena() {
    PASSWORD=$(zenity --password --title="Contrase√±a de sudo" --text="Ingrese su contrase√±a de sudo:")
}

# Funci√≥n para mostrar la bienvenida
mostrar_bienvenida() {
    zenity --info --title="Bienvenido a InstallArch" --text="\n\nüíª Bienvenido a InstallArch\n\nTu gestor para la instalaci√≥n y configuraci√≥n de Arch Linux\n\nüåê https://www.github.com/mxhectorvega/installarch\n\nüóíÔ∏è El log de la instalaci√≥n se guardar√° en /tmp/installarch.log\n\n" --width=400 --height=200
}

# Funci√≥n para listar y seleccionar scripts del repositorio
listar_scripts() {
    # Obtener la lista de archivos desde el repositorio y buscar aquellos que comienzan con #!/usr/bin/env bash
    scripts=$(curl -s https://api.github.com/repos/mxhectorvega/installarch/contents | jq -r '.[] | select(.type=="file") | .name')
    lista=()
    for script in $scripts; do
        content=$(curl -s https://raw.githubusercontent.com/mxhectorvega/installarch/main/$script)
        if echo "$content" | grep -q '^#!/usr/bin/env bash'; then
            lista+=("$script")
        fi
    done

    if [ ${#lista[@]} -eq 0 ]; then
        zenity --error --text="No se encontraron scripts en el repositorio." --width=300 --height=100
        exit 1
    fi

    seleccion=$(zenity --list --title="Seleccione un script para ejecutar" --column="Scripts" "${lista[@]}" --width=400 --height=300)
    echo "$seleccion" > /tmp/menuopt
}

# Funci√≥n para ejecutar el script seleccionado y mostrar el progreso
ejecutar_script() {
    script_url="https://raw.githubusercontent.com/mxhectorvega/installarch/main/$seleccion"
    zenity --info --title="Instalaci√≥n de $seleccion" --text="Descargando y ejecutando $seleccion..." --width=300 --height=100

    # Crear archivo de registro con permisos adecuados
    sudo touch /tmp/installarch.log
    sudo chmod 666 /tmp/installarch.log

    # Ejecutar el script seleccionado y mostrar el progreso en un cuadro de di√°logo
    (
        echo "$PASSWORD" | sudo -S bash -c "wget -q -O - \"$script_url\" | bash 2>&1 | tee /tmp/installarch.log"
    ) | zenity --progress --title="Progreso de instalaci√≥n" --text="Instalando $seleccion..." --percentage=0 --width=400 --height=100 --auto-close

    # Mostrar el contenido del archivo de registro en tiempo real
    zenity --text-info --title="Progreso de instalaci√≥n" --filename="/tmp/installarch.log" --width=600 --height=400
}

# Verificar si zenity, wget y jq est√°n instalados, si no, instalarlos
for cmd in zenity wget jq; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "$PASSWORD" | sudo -S pacman -S "$cmd" --noconfirm --needed
    fi
done

# Mostrar bienvenida
mostrar_bienvenida

# Pedir contrase√±a sudo
mostrar_contrasena

# Listar scripts y seleccionar uno
listar_scripts

# Ejecutar el script seleccionado y mostrar el progreso
ejecutar_script

# Mensaje final
zenity --info --title="Finalizado" --text="\n\n‚ù§Ô∏è Gracias por usar InstallArch\n\nüåê https://www.github.com/mxhectorvega/installarch\n\n" --width=400 --height=200

# Limpiar archivos temporales si existen
[ -f /tmp/menuopt ] && rm /tmp/menuopt
