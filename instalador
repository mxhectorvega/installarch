#!/usr/bin/env bash

# Configuraci칩n inicial
set -e

# Variables globales
LOG_DIR="$HOME/installarch_logs"
LOG_FILE="$LOG_DIR/installation.log"
REPO_DIR="$HOME/installarch"
PROGRESS=0

# Crear directorio de logs si no existe
mkdir -p "$LOG_DIR"

# Funci칩n para mostrar mensajes de error
mostrar_error() {
    whiptail --title "Error" --msgbox "$1" 8 78
}

# Funci칩n para pedir contrase침a de root
pedir_contrase침a() {
    PASSWORD=$(whiptail --passwordbox "Ingresa la contrase침a de root:" 8 78 --title "Permisos de administrador" 3>&1 1>&2 2>&3)
    echo "$PASSWORD" | sudo -S echo "" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        mostrar_error "Contrase침a incorrecta. Por favor, int칠ntalo de nuevo."
        pedir_contrase침a
    fi
}

# Funci칩n para actualizar repositorio
actualizar_repositorio() {
    if [ -d "$REPO_DIR" ]; then
        cd "$REPO_DIR"
        git pull
    else
        git clone https://github.com/mxhectorvega/installarch "$REPO_DIR"
    fi
}

# Funci칩n para obtener lista de scripts
obtener_lista_scripts() {
    find "$REPO_DIR" -type f -exec awk '/^#!\/usr\/bin\/env bash/ { print FILENAME }' {} \; | xargs -n1 basename
}

# Pantalla de bienvenida
pantalla_bienvenida() {
    whiptail --title "Bienvenido" --msgbox "춰Hola! Este script guardar치 el log en: $LOG_FILE" 10 60
}

# Pantalla de selecci칩n de script
seleccionar_script() {
    SCRIPTS=$(obtener_lista_scripts)
    OPTIONS=()
    for script in $SCRIPTS; do
        OPTIONS+=("$script" "")
    done
    SCRIPT_SELECCIONADO=$(whiptail --title "Selecciona un script" --menu "Elige el script a ejecutar:" 20 78 10 "${OPTIONS[@]}" 3>&1 1>&2 2>&3)
    if [ -z "$SCRIPT_SELECCIONADO" ]; then
        mostrar_error "No seleccionaste ning칰n script."
        seleccionar_script
    fi
}

# Funci칩n para ejecutar script seleccionado
ejecutar_script() {
    TOTAL_PASOS=$(grep -c "^" "$REPO_DIR/$SCRIPT_SELECCIONADO")
    (
    STEP=0
    bash "$REPO_DIR/$SCRIPT_SELECCIONADO" 2>&1 | while read -r line; do
        echo "$line" >> "$LOG_FILE"
        ((STEP++))
        PROGRESS=$(( STEP * 100 / TOTAL_PASOS ))
        echo $PROGRESS
    done
    ) | whiptail --title "Instalando" --gauge "Instalando el script seleccionado..." 6 60 0
}

# Pantalla final
pantalla_final() {
    whiptail --title "Instalaci칩n Completa" --msgbox "鮫봺잺 Suscr칤bete! 游깷 https://www.youtube.com/mxhectorvega" 10 60
}

# Programa principal
main() {
    pantalla_bienvenida
    actualizar_repositorio
    seleccionar_script
    pedir_contrase침a
    ejecutar_script || {
        mostrar_error "La instalaci칩n ha fallado. Iniciando rollback..."
        # Aqu칤 puedes agregar tu l칩gica de rollback
        exit 1
    }
    pantalla_final
}

main
