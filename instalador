#!/usr/bin/env bash

# FunciÃ³n para solicitar la contraseÃ±a al inicio con puntos por cada carÃ¡cter
mostrar_contrasena() {
    PASSWORD=$(whiptail --passwordbox "Ingrese su contraseÃ±a de sudo:\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 10 60 3>&1 1>&2 2>&3)
    echo "$PASSWORD" | sudo -S echo "ContraseÃ±a ingresada correctamente." > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        whiptail --title "Error" --msgbox "ContraseÃ±a incorrecta. Intente de nuevo.\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 10 60
        mostrar_contrasena
    fi
}

# FunciÃ³n para mostrar la bienvenida
mostrar_bienvenida() {
    whiptail --title "Bienvenido a InstallArch" --msgbox "\n\nğŸ’» Bienvenido a InstallArch\n\nTu gestor para la instalaciÃ³n y configuraciÃ³n de Arch Linux\n\nğŸŒ https://www.github.com/mxhectorvega/installarch\n\nğŸ—’ï¸ El log de la instalaciÃ³n se guardarÃ¡ en /tmp/installarch.log\n" 15 60
}

# FunciÃ³n para listar y seleccionar scripts del repositorio
listar_scripts() {
    # Obtener la lista de archivos desde el repositorio y buscar aquellos que comienzan con #!/usr/bin/env bash
    scripts=$(curl -s https://api.github.com/repos/mxhectorvega/installarch/contents | jq -r '.[] | select(.type=="file") | .name')
    lista=()
    for script in $scripts; do
        content=$(curl -s https://raw.githubusercontent.com/mxhectorvega/installarch/main/$script)
        if echo "$content" | grep -q '^#!/usr/bin/env bash'; then
            lista+=("$script" "")
        fi
    done

    if [ ${#lista[@]} -eq 0 ]; then
        whiptail --title "Error" --msgbox "No se encontraron scripts en el repositorio.\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 10 50
        exit 1
    fi

    seleccion=$(whiptail --title "Seleccione un script para ejecutar" --menu "Elige el script a ejecutar:\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 20 60 15 "${lista[@]}" 3>&1 1>&2 2>&3)
    echo "$seleccion" > /tmp/menuopt
}

# FunciÃ³n para ejecutar el script seleccionado y asegurarse de que makepkg se ejecute como usuario
ejecutar_script() {
    script_url="https://raw.githubusercontent.com/mxhectorvega/installarch/main/$seleccion"
    whiptail --title "InstalaciÃ³n de $seleccion" --infobox "Descargando y ejecutando $seleccion...\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 10 70

    # Crear archivo de registro con permisos adecuados
    sudo touch /tmp/installarch.log
    sudo chmod 666 /tmp/installarch.log

    # Descargar el script y guardarlo en un archivo temporal
    temp_script="/tmp/$(basename "$seleccion")"
    wget -q -O "$temp_script" "$script_url"
    chmod +x "$temp_script"

    # Ejecutar el script temporal y asegurar que makepkg se ejecute como usuario
    (
        sudo -u $USER bash "$temp_script" | tee /tmp/installarch.log
    ) | whiptail --title "Progreso de instalaciÃ³n" --gauge "Instalando $seleccion...\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 10 70 0

    # Mostrar el contenido del archivo de registro en tiempo real
    whiptail --title "Progreso de instalaciÃ³n" --textbox /tmp/installarch.log 20 70
}

# Verificar si whiptail, wget y jq estÃ¡n instalados, si no, instalarlos
for cmd in whiptail wget jq; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "$PASSWORD" | sudo -S pacman -S "$cmd" --noconfirm --needed
    fi
done

# Mostrar bienvenida
mostrar_bienvenida

# Pedir contraseÃ±a sudo
mostrar_contrasena

# Listar scripts y seleccionar uno
listar_scripts

# Ejecutar el script seleccionado y asegurarse de que makepkg se ejecute como usuario
ejecutar_script

# Mensaje final
whiptail --title "Finalizado" --msgbox "\n\nâ¤ï¸ Gracias por usar InstallArch\n\nğŸŒ https://www.github.com/mxhectorvega/installarch\n\nğŸ—’ï¸ Log: /tmp/installarch.log" 15 60

# Limpiar archivos temporales si existen
[ -f /tmp/menuopt ] && rm /tmp/menuopt
