#!/bin/sh

# Variables
LOG_FILE="/tmp/installer.log"
REPO_URL="https://github.com/mxhectorvega/installarch"
CLONE_DIR="/tmp/installarch"
SCRIPT_DIR="$CLONE_DIR"

# Función para mostrar mensajes de error y salir
error() {
    echo "ERROR: $1" >> "$LOG_FILE"
    whiptail --title "Error" --msgbox "Ocurrió un error: $1" 8 50
    exit 1
}

# Verificar dependencias
check_dependencies() {
    if ! command -v whiptail >/dev/null 2>&1; then
        echo "Instalando whiptail..."
        sudo pacman -S --noconfirm libnewt >/dev/null 2>&1 || error "No se pudo instalar whiptail."
    fi
    if ! command -v git >/dev/null 2>&1; then
        echo "Instalando git..."
        sudo pacman -S --noconfirm git >/dev/null 2>&1 || error "No se pudo instalar git."
    fi
    if ! command -v makepkg >/dev/null 2>&1; then
        echo "Instalando makepkg..."
        sudo pacman -S --noconfirm pacman >/dev/null 2>&1 || error "No se pudo instalar makepkg."
    fi
}

# Pantalla de Bienvenida
welcome_screen() {
    whiptail --title "Bienvenido" --yesno "Bienvenido al instalador de scripts de mxhectorvega.\n\nEl registro de errores se almacenará en:\n$LOG_FILE\n\n¿Desea continuar?" 12 50 \
    --yes-button "Iniciar" --no-button "Cancelar" \
    || exit 0
}

# Clonar repositorio y listar scripts
clone_and_list_scripts() {
    if [ -d "$CLONE_DIR" ]; then
        rm -rf "$CLONE_DIR"
    fi
    git clone "$REPO_URL" "$CLONE_DIR" >/dev/null 2>&1 || error "No se pudo clonar el repositorio."

    SCRIPTS=$(find "$SCRIPT_DIR" -type f -executable ! -name "*.*" | awk -F/ '{print $NF}')
    if [ -z "$SCRIPTS" ]; then
        error "No se encontraron scripts ejecutables en el repositorio."
    fi

    SCRIPT=$(whiptail --title "Lista de Scripts" --menu "Seleccione un script para ejecutar:" 15 50 5 \
    $(echo "$SCRIPTS" | awk '{print $1, "Script"}') \
    3>&1 1>&2 2>&3) || return 1

    whiptail --title "Confirmación" --yesno "¿Desea ejecutar el script '$SCRIPT'?" 8 50 \
    --yes-button "Siguiente" --no-button "Atrás" \
    || clone_and_list_scripts
}

# Ejecutar script seleccionado con barra de progreso y salida verbosa
run_script() {
    whiptail --title "Instalación" --msgbox "Iniciando la instalación del script '$SCRIPT'..." 8 50

    # Crear un archivo temporal para la salida verbosa
    TEMP_LOG=$(mktemp)

    if grep -q "sudo" "$SCRIPT_DIR/$SCRIPT"; then
        PASSWORD=$(whiptail --title "Contraseña" --passwordbox "El script requiere permisos de root. Ingrese su contraseña:" 8 50 3>&1 1>&2 2>&3) || return 1
        echo "$PASSWORD" | sudo -S "$SCRIPT_DIR/$SCRIPT" >> "$TEMP_LOG" 2>&1 &
    else
        "$SCRIPT_DIR/$SCRIPT" >> "$TEMP_LOG" 2>&1 &
    fi

    PID=$!
    while ps -p $PID > /dev/null; do
        sleep 1
        echo "50"
    done | whiptail --gauge "Instalando el script '$SCRIPT'..." 6 50 0

    wait $PID
    if [ $? -ne 0 ]; then
        cat "$TEMP_LOG" >> "$LOG_FILE"
        error "La instalación falló. Consulte el registro de errores en $LOG_FILE."
    fi

    cat "$TEMP_LOG" >> "$LOG_FILE"
    rm -f "$TEMP_LOG"

    whiptail --title "Instalación Completada" --msgbox "La instalación del script '$SCRIPT' ha finalizado." 8 50
}

# Pantalla final
final_screen() {
    whiptail --title "Finalizado" --yesno "♥️ Suscríbete! 🌐 https://www.youtube.com/mxhectorvega\n\n¿Desea revisar el registro de errores?" 10 50 \
    --yes-button "Mostrar LOG" --no-button "Finalizar" \
    && whiptail --title "Registro de Errores" --textbox "$LOG_FILE" 20 80
}

# Main
main() {
    check_dependencies
    welcome_screen
    while true; do
        clone_and_list_scripts && run_script && break
    done
    final_screen
}

main
