#!/usr/bin/env bash

# Configuración
LOG_FILE="/tmp/installer.log"
REPO_DIR="/tmp/installarch"
REPO_URL="https://github.com/mxhectorvega/installarch"

# Función para registrar errores
log_error() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Función para clonar el repositorio
clone_repo() {
    if [ ! -d "$REPO_DIR" ]; then
        git clone "$REPO_URL" "$REPO_DIR" || { log_error "Error al clonar el repositorio"; return 1; }
    fi
    return 0
}

# Función para listar scripts
list_scripts() {
    find "$REPO_DIR" -type f -exec awk '/^#!\/usr\/bin\/env bash/{print FILENAME}{nextfile}' {} + | xargs -n1 basename
}

# Función para ejecutar un script
run_script() {
    local script="$1"
    local script_path="$REPO_DIR/$script"

    if [ -x "$script_path" ]; then
        if grep -q "sudo" "$script_path"; then
            dialog --insecure --passwordbox "Ingresar contraseña para ejecutar $script:" 10 50 2> /tmp/password
            PASSWORD=$(cat /tmp/password)
            rm /tmp/password
            echo "$PASSWORD" | sudo -S bash "$script_path" 2>&1 | tee -a "$LOG_FILE"
        else
            bash "$script_path" 2>&1 | tee -a "$LOG_FILE"
        fi
    else
        log_error "El script $script no es ejecutable"
        dialog --msgbox "El script $script no es ejecutable." 10 50
    fi
}

# Pantalla de bienvenida
welcome_screen() {
    dialog --title "Bienvenido" --msgbox "Bienvenido al instalador de scripts de mxhectorvega.\n\nEl registro de errores se almacenará en: $LOG_FILE" 10 50
    dialog --yesno "¿Desea iniciar la instalación?" 10 50
    case $? in
        0) clone_repo && script_selection_screen ;;
        1) exit 0 ;;
    esac
}

# Pantalla de selección de scripts
script_selection_screen() {
    local scripts=($(list_scripts))
    local options=()
    for script in "${scripts[@]}"; do
        options+=("$script" "")
    done

    local choice
    choice=$(dialog --title "Seleccione un script" --menu "Seleccione un script para ejecutar:" 15 50 5 "${options[@]}" 3>&1 1>&2 2>&3)

    case $? in
        0) run_script "$choice" && installation_screen ;;
        1) welcome_screen ;;
        255) exit 0 ;;
    esac
}

# Pantalla de instalación
installation_screen() {
    dialog --title "Instalación" --msgbox "La instalación ha finalizado. Puede revisar el registro de errores en: $LOG_FILE" 10 50
    final_screen
}

# Pantalla final
final_screen() {
    dialog --title "Finalizado" --msgbox "♥️ Suscríbete! 🌐 https://www.youtube.com/mxhectorvega" 10 50
    dialog --yesno "¿Desea mostrar el registro de errores?" 10 50
    case $? in
        0) dialog --textbox "$LOG_FILE" 20 80 ;;
        1) exit 0 ;;
    esac
}

# Iniciar el instalador
welcome_screen
