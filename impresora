#!/usr/bin/env bash

# Instalaci贸n y configuraci贸n de impresoras en Arch Linux.
# Repositorio: https://github.com/mxhectorvega/installarch
# Ejecuci贸n: curl -L is.gd/mximpresora | bash
# Fecha de actualizaci贸n: 04/02/2025
# Versi贸n: 5.0

# Funci贸n para mostrar mensajes con formato
imprimir_mensaje() {
    local mensaje="$1"
    echo -e "\n\n\n\n\n\n\n\n\t\t\t\t\t\t\t$mensaje\n\n\n\n\n\n\n\n\n\n"
    sleep 3
}

# Actualizar y sincronizar repositorios
sudo pacman -Sy --noconfirm

# Instalar paquetes esenciales para la impresora
paquetes_impresora=(
    "system-config-printer"
    "cups"
    "cups-pdf"
    "ghostscript"
    "gsfonts"
    "hplip"
    "foomatic-db-engine"
    "foomatic-db"
    "foomatic-db-ppds"
    "foomatic-db-nonfree"
    "foomatic-db-nonfree-ppds"
)

sudo pacman -S "${paquetes_impresora[@]}" --noconfirm --needed

# Agregar el usuario al grupo de impresoras y otros grupos necesarios
sudo gpasswd -a "$(whoami)" sys
sudo gpasswd -a "$(whoami)" lp

# Iniciar y habilitar el servicio CUPS
sudo systemctl enable --now cups

# Verificar si git est谩 instalado, si no, instalarlo
if ! command -v git &> /dev/null; then
    echo "git no est谩 instalado. Instal谩ndolo..."
    sudo pacman -S git --noconfirm --needed
fi

# Clonar los controladores para impresoras Epson L3210 de un repositorio github
echo "Clonando e instalando controladores Epson L3210..."
if git clone https://github.com/razein97/Epson-L3210-Arch-Driver; then
    cd Epson-L3210-Arch-Driver || exit
    if makepkg -si --noconfirm; then
        echo "Controladores instalados exitosamente."
    else
        echo "Error al instalar los controladores."
        exit 1
    fi
    cd ..
    rm -rf Epson-L3210-Arch-Driver
else
    echo "Error al clonar el repositorio."
    exit 1
fi

# FIX problema con el filtro (se pone en pausa la impresi贸n).
if [ ! -f /usr/lib/cups/filter/epson_inkjet_printer_filter ]; then
    sudo ln -s /opt/epson-inkjet-printer-202101w/cups/lib/filter/epson_inkjet_printer_filter /usr/lib/cups/filter/epson_inkjet_printer_filter
    echo "Enlace simb贸lico para el filtro de impresi贸n creado."
else
    echo "El enlace simb贸lico para el filtro de impresi贸n ya existe."
fi

# Mensaje final
imprimir_mensaje "ワ Suscr铆bete!\n\n\t\t\t\t\t\t\t https://www.youtube.com/mxhectorvega"

# Comando opcional para verificar el estado de los servicios de impresi贸n
# sudo systemctl status cups
