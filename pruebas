#!/bin/bash

# Comentario: Obteniendo variables de entorno del sistema anfitrión
echo "🟢 Obteniendo variables de entorno del sistema..."
source /etc/environment

# Comentario: Configurando Snapper para los subvolúmenes @, @home
echo "🟢 Configurando Snapper para los subvolúmenes @, @home..."
snapper -c root create-config /
snapper -c home create-config /home

# Comentario: Configurando SystemdBoot
echo "🟢 Configurando SystemdBoot..."
bootctl --path=/boot install
cat << EOF > /boot/loader/loader.conf
default arch-latest
timeout 3
editor no
EOF

cat << EOF > /boot/loader/entries/arch.conf
title Arch Linux
linux /vmlinuz-linux
initrd /initramfs-linux.img
options root=UUID=$(findmx PARTUUID / btrfs) rw rootflags=subvol=@
EOF

# Comentario: Configurando Timers y Servicios de Snapper
echo "🟢 Configurando Timers y Servicios de Snapper..."
systemctl enable --now snapper-timeline.timer
systemctl enable --now snapper-cleanup.timer

# Comentario: Creando servicio de actualización transaccional
echo "🟢 Creando servicio de actualización transaccional..."
cat << EOF > /etc/systemd/system/transactional-update.service
[Unit]
Description=Transactional Updates
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/transactional-update.sh

[Install]
WantedBy=multi-user.target
EOF

cat << EOF > /usr/local/bin/transactional-update.sh
#!/bin/bash

# Comentario: Actualizando el sistema
echo "🟢 Actualizando el sistema..."
pacman -Syu --noconfirm

# Comentario: Creando instantáneas de Snapper
echo "🟢 Creando instantáneas de Snapper..."
snapper -c root create --description "System Update"
snapper -c home create --description "System Update"

# Comentario: Reiniciando el sistema
echo "🟢 Reiniciando el sistema..."
systemctl reboot
EOF

# Comentario: Dando permisos de ejecución al script de actualización
echo "🟢 Dando permisos de ejecución al script de actualización..."
chmod +x /usr/local/bin/transactional-update.sh

# Comentario: Habilitando y activando el servicio de actualización transaccional
echo "🟢 Habilitando y activando el servicio de actualización transaccional..."
systemctl enable --now transactional-update.service

# Comentario: Proceso completado
echo "🟢 Proceso completado. El sistema ahora tiene actualizaciones transaccionales integradas."
#test1
