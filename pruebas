#!/usr/bin/env bash

# Instalaci√≥n de paquetes flatpak para el usuario dom√©stico.
# Repositorio: https://github.com/mxhectorvega/installarch
# Ejecuci√≥n: curl -L is.gd/mxflatpak | bash
# Fecha de actualizaci√≥n: 04/02/2025
# Versi√≥n: 5.0

# Funci√≥n para mostrar mensajes enmarcados con colores
imprimir_mensaje() {
    local mensaje="$1"
    local border_color="\e[36m"  # Cyan
    local text_color="\e[97m"    # Blanco
    local reset="\e[0m"
    local ancho=$(tput cols)

    clear

    # Borde superior
    printf "${border_color}‚ï≠%*s‚ïÆ${reset}\n" "$((ancho - 2))" "" | tr ' ' '‚îÄ'

    # L√≠nea vac√≠a
    printf "${border_color}‚îÇ%*s‚îÇ${reset}\n" "$((ancho - 2))" ""

    # Dividir mensaje en l√≠neas
    IFS=$'\n' read -d '' -ra lineas <<< "$mensaje"

    for linea in "${lineas[@]}"; do
        largo=${#linea}
        espacio=$(( (ancho - 2 - largo) / 2 ))
        printf "${border_color}‚îÇ${text_color}%*s%s%*s${border_color}‚îÇ${reset}\n" "$espacio" "" "$linea" "$espacio" ""
    done

    # L√≠nea vac√≠a
    printf "${border_color}‚îÇ%*s‚îÇ${reset}\n" "$((ancho - 2))" ""

    # Borde inferior
    printf "${border_color}‚ï∞%*s‚ïØ${reset}\n" "$((ancho - 2))" "" | tr ' ' '‚îÄ'

    sleep 3
}

# Verificar si flatpak est√° instalado
if ! command -v flatpak &> /dev/null; then
    imprimir_mensaje "Flatpak no est√° instalado.\nInstal√°ndolo..."
    sudo pacman -S flatpak --noconfirm --needed
fi

# Agregar repositorio flathub
if ! flatpak remote-list | grep -q flathub; then
    imprimir_mensaje "Agregando el repositorio flathub..."
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
fi

# Listas de paquetes (igual que en tu versi√≥n original)
paquetes_gnome=(...)
paquetes_kde=(...)
paquete_adicional="https://sober.vinegarhq.org/sober.flatpakref"

# Bucle de selecci√≥n
while true; do
    clear
    mensaje_menu=$'¬øQu√© lista de paquetes flatpak deseas instalar?\n\n1) Para entorno GNOME (script minimal)\n2) Para entorno KDE Plasma (archinstall)'
    imprimir_mensaje "$mensaje_menu"

    # Centrar prompt de entrada
    ancho=$(tput cols)
    prompt="Selecciona una opci√≥n (1 o 2): "
    espacio=$(( (ancho - ${#prompt}) / 2 ))
    printf "%*s" "$espacio" ""
    read -rp "$prompt" opcion

    case $opcion in
        1)
            imprimir_mensaje "Instalando paquetes GNOME..."
            for paquete in "${paquetes_gnome[@]}"; do
                flatpak install --user -y "$paquete"
            done
            flatpak install --user -y "$paquete_adicional"
            break
            ;;
        2)
            imprimir_mensaje "Instalando paquetes KDE..."
            for paquete in "${paquetes_kde[@]}"; do
                flatpak install --user -y "$paquete"
            done
            flatpak install --user -y "$paquete_adicional"
            imprimir_mensaje "Instalando paquetes adicionales..."
            sudo pacman -Sy flatpak-kcm spectacle partitionmanager --noconfirm --needed
            break
            ;;
        *)
            imprimir_mensaje "Opci√≥n no v√°lida"
            ;;
    esac
done

# Mensaje final
imprimir_mensaje $'‚ô•Ô∏è Suscr√≠bete!\n\nüåê https://www.youtube.com/mxhectorvega'
