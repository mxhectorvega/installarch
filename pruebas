#!/bin/bash

# Establecer variables
LOG_FILE="/var/log/installarch.log"
REPO_URL="https://github.com/mxhectorvega/installarch"
INSTALL_DIR="/opt/installarch"
SCRIPTS_DIR="$INSTALL_DIR/scripts"

# Función para mostrar mensajes de error
mostrar_error() {
    echo "Error: $1"
    echo "Error: $1" >> "$LOG_FILE"
    exit 1
}

# Función para instalar dependencias
instalar_dependencias() {
    sudo pacman -Sy --needed git || mostrar_error "Error al instalar git"
    sudo pacman -Sy --needed base-devel || mostrar_error "Error al instalar base-devel"
}

# Función para clonar el repositorio
clonar_repositorio() {
    git clone "$REPO_URL" "$INSTALL_DIR" || mostrar_error "Error al clonar el repositorio"
}

# Función para verificar y validar scripts
validar_scripts() {
    for script in $(find "$SCRIPTS_DIR" -type f -executable);
    do
        shellcheck "$script" || mostrar_error "Error de sintaxis en $script"
    done
}

# Función para mostrar la pantalla de bienvenida
pantalla_bienvenida() {
    clear
    echo "Bienvenido al instalador de scripts de mxhectorvega"
    echo "Los registros de instalación se almacenarán en $LOG_FILE"
    echo "Presiona Enter para continuar o Ctrl+C para cancelar"
    read -r
}

# Función para mostrar la lista de scripts
pantalla_lista_scripts() {
    clear
    echo "Lista de scripts disponibles:"
    scripts=($(find "$SCRIPTS_DIR" -type f -executable -exec basename {} \;))
    for i in "${!scripts[@]}"; do
        echo "$((i+1)). ${scripts[$i]}"
    done
    echo "Selecciona un script para ejecutar (número):"
    read -r seleccion
    seleccion=$((seleccion-1))
    if [ -z "${scripts[$seleccion]}" ]; then
        mostrar_error "Selección no válida"
    fi
    SCRIPT_SELECCIONADO="${scripts[$seleccion]}"
}

# Función para mostrar la pantalla de instalación
pantalla_instalacion() {
    clear
    echo "Instalando script: $SCRIPT_SELECCIONADO"
    echo "Progreso:"

    # Ejecutar el script seleccionado y mostrar barra de progreso
    "$SCRIPTS_DIR/$SCRIPT_SELECCIONADO" || mostrar_error "Error al ejecutar $SCRIPT_SELECCIONADO"
}

# Función para mostrar la pantalla final
pantalla_final() {
    clear
    echo "♥️ Suscríbete! 🌐 https://www.youtube.com/mxhectorvega"
    echo "Presiona Enter para mostrar el archivo de registros o Ctrl+C para finalizar"
    read -r
    cat "$LOG_FILE"
}

# Función principal
main() {
    pantalla_bienvenida
    instalar_dependencias
    clonar_repositorio
    validar_scripts
    pantalla_lista_scripts
    pantalla_instalacion
    pantalla_final
}

# Ejecutar función principal
main
