#!/bin/bash

# Constantes
REPO_URL="https://github.com/mxhectorvega/installarch"
REPO_DIR="$HOME/installarch"
LOG_FILE="$HOME/installarch_install.log"
ROOT_PASS_FILE="$HOME/.root_pass"
USER_PASS_FILE="$HOME/.user_pass"

# Funciones
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

clean_up() {
    rm -rf "$REPO_DIR"
    log "Clean up completed"
}

trap 'whiptail --msgbox "Error: Something went wrong!" 8 78; log "Installation failed"; exit 1' ERR

welcome_screen() {
    if whiptail --title "Bienvenido" --yesno "Bienvenido al instalador de scripts de mxhectorvega.\nEl archivo de registros se almacenar치 en $LOG_FILE." 10 60; then
        log "User accepted the welcome screen"
    else
        log "User canceled the installation"
        exit 1
    fi
}

list_scripts_screen() {
    local scripts_list=$(find "$REPO_DIR" -maxdepth 1 -type f -executable | awk -F'/' '{print $NF}' | grep -v '\.')
    local scripts=()
    local index=1

    while read -r script; do
        scripts+=("$index" "$script")
        ((index++))
    done <<< "$scripts_list"

    CHOICE=$(whiptail --title "Lista de scripts" --menu "Elige un script para ejecutar" 20 78 10 "${scripts[@]}" 3>&1 1>&2 2>&3)
    SCRIPT_TO_RUN=$(echo "$scripts_list" | sed -n "${CHOICE}p")
}

install_screen() {
    {
        echo 0
        log "Installation started"

        cd "$REPO_DIR" || exit

        for ((i = 1; i <= 10; i++)); do
            echo $((i * 10))
            sleep 1
        done

        su -c "$SCRIPT_TO_RUN"

        echo 100
        log "Installation completed successfully"
    } | whiptail --gauge "Installing..." 6 50 0
}

final_screen() {
    whiptail --title "Instalaci칩n completa" --msgbox "鮫봺잺 Suscr칤bete! 游깷 https://www.youtube.com/mxhectorvega" 10 60
}

store_passwords() {
    ROOT_PASS=$(whiptail --passwordbox "Introduce la contrase침a root:" 8 78 --title "Contrase침a root" 3>&1 1>&2 2>&3)
    USER_PASS=$(whiptail --passwordbox "Introduce la contrase침a de usuario:" 8 78 --title "Contrase침a de usuario" 3>&1 1>&2 2>&3)
    echo "$ROOT_PASS" > "$ROOT_PASS_FILE"
    echo "$USER_PASS" > "$USER_PASS_FILE"
    log "Passwords stored"
}

# Main
log "Installation script started"
clean_up
welcome_screen

if [ ! -d "$REPO_DIR" ]; then
    git clone "$REPO_URL" "$REPO_DIR"
else
    rm -rf "$REPO_DIR"
    git clone "$REPO_URL" "$REPO_DIR"
fi
log "Repository cloned"

store_passwords
list_scripts_screen
install_screen
final_screen
clean_up

log "Installation script finished"
