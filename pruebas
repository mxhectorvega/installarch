#!/usr/bin/env bash
set -euo pipefail

exec 5> "$HOME/arch_install.debug.log"
BASH_XTRACEFD="5"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
NC='\033[0m'

LOG_FILE="$HOME/arch_install.log"
ERROR_LOG="$HOME/arch_install.error.log"
DEBUG_DIR="$HOME/arch_install.debug"
INSTALLED_PACKAGES=()
TEMP_DIR=$(mktemp -d /tmp/arch_installer_XXXXXX)

initialize_logs() {
    echo -e "Fecha de inicio: $(date)" > "$LOG_FILE"
    echo -e "Usuario: $(whoami)" >> "$LOG_FILE"
    echo -e "Directorio actual: $(pwd)" >> "$LOG_FILE"
    echo -e "VersiÃ³n de Bash: $BASH_VERSION" >> "$LOG_FILE"
    echo -e "Variables de entorno:" >> "$LOG_FILE"
    env >> "$LOG_FILE"
}

check_requirements() {
    echo -e "${YELLOW}Verificando requisitos...${NC}"
    if ! grep -q "Arch Linux" /etc/os-release; then
        echo -e "${RED}Error: Este script solo funciona en Arch Linux${NC}"
        exit 1
    fi

    if ! command -v sudo &> /dev/null; then
        echo -e "${RED}Error: Falta la herramienta sudo${NC}"
        if command -v pacman &> /dev/null; then
            echo -e "${YELLOW}Intentando instalar sudo...${NC}"
            if pacman -S --noconfirm sudo; then
                echo -e "${GREEN}âœ“ Sudo instalado correctamente${NC}"
            else
                echo -e "${RED}Error: No se pudo instalar sudo${NC}"
                exit 1
            fi
        else
            echo -e "${RED}Error: No se puede instalar sudo sin pacman${NC}"
            exit 1
        fi
    fi

    required_tools=("curl" "tee" "less" "pacman")
    for tool in "${required_tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            echo -e "${RED}Error: Falta la herramienta requerida: $tool${NC}"
            if command -v sudo &> /dev/null && command -v pacman &> /dev/null; then
                echo -e "${YELLOW}Intentando instalar $tool...${NC}"
                if sudo pacman -S --noconfirm "$tool"; then
                    echo -e "${GREEN}âœ“ $tool instalado correctamente${NC}"
                else
                    echo -e "${RED}Error: No se pudo instalar $tool${NC}"
                    exit 1
                fi
            else
                echo -e "${RED}Error: No se pueden instalar herramientas automÃ¡ticamente sin sudo o pacman${NC}"
                exit 1
            fi
        fi
    done

    mkdir -p "$TEMP_DIR" "$DEBUG_DIR"
    if ! touch "$LOG_FILE" 2>/dev/null || ! touch "$ERROR_LOG" 2>/dev/null; then
        echo -e "${RED}Error: No se puede escribir en los archivos de log${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ“ Todos los requisitos cumplidos${NC}"
}

cleanup() {
    local status=$?
    if [ $status -ne 0 ]; then
        echo -e "\n${RED}Error detectado. CÃ³digo: $status${NC}"
        echo -e "${RED}Consultando logs para mÃ¡s detalles...${NC}"
        if [ -f "$ERROR_LOG" ]; then
            echo -e "\n${YELLOW}Ãšltimas lÃ­neas del log de errores:${NC}"
            tail -n 20 "$ERROR_LOG"
        fi
        echo -e "\n${YELLOW}Guardando archivos de debug en: $DEBUG_DIR${NC}"
        mkdir -p "$DEBUG_DIR"
        cp -r "$TEMP_DIR"/* "$DEBUG_DIR/" 2>/dev/null || true
    else
        rm -rf "$TEMP_DIR"
    fi
}

trap cleanup EXIT
trap 'trap - EXIT; cleanup; exit 1' INT TERM

show_welcome() {
    clear
    echo -e "${GREEN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${GREEN}â”‚     Bienvenido al instalador de          â”‚${NC}"
    echo -e "${GREEN}â”‚        scripts de mxhectorvega           â”‚${NC}"
    echo -e "${GREEN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo -e "\nArchivo de registros: ${BLUE}$LOG_FILE${NC}"
    echo -e "Archivo de errores: ${BLUE}$ERROR_LOG${NC}\n"
    sleep 1
}

show_menu() {
    echo -e "${YELLOW}Lista de Scripts Disponibles:${NC}\n"
    echo -e "${CYAN}1)${NC} Optimizaciones para Pacman, Repo Chaotic y Paru - AUR Helper"
    echo -e "${CYAN}2)${NC} Software flatpak para el usuario domÃ©stico"
    echo -e "${CYAN}3)${NC} Entorno de escritorio Gnome 47.x"
    echo -e "${CYAN}4)${NC} Controladores Wifi para MacBook Pro y Air"
    echo -e "${CYAN}5)${NC} Controladores para impresora Epson L3210"
    echo -e "${CYAN}6)${NC} Configuraciones para Hyprland"
    echo -e "${CYAN}0)${NC} Salir\n"
}

register_package() {
    INSTALLED_PACKAGES+=("$1")
    echo "Paquete registrado: $1" >> "$LOG_FILE"
}

execute_script() {
    local url="$1"
    local temp_script="$TEMP_DIR/script.sh"
    echo -e "\n${YELLOW}Verificando URL: $url${NC}" | tee -a "$LOG_FILE"
    if ! curl -I -s "$url" | grep -q "HTTP/[1-9].[0-9] [23].."; then
        echo -e "${RED}Error: La URL no es accesible o no responde correctamente.${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    echo -e "\n${YELLOW}Descargando script...${NC}" | tee -a "$LOG_FILE"
    if ! curl --retry 3 -s "$url" > "$temp_script"; then
        echo -e "${RED}Error: No se pudo descargar el script despuÃ©s de 3 intentos.${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    if [ ! -s "$temp_script" ]; then
        echo -e "${RED}Error: Script descargado estÃ¡ vacÃ­o${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    chmod +x "$temp_script"
    echo -e "${GREEN}Script descargado correctamente${NC}" | tee -a "$LOG_FILE"

    if ! bash -n "$temp_script"; then
        echo -e "${RED}Error: El script contiene errores de sintaxis${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    echo -e "\n${YELLOW}Ejecutando script...${NC}\n" | tee -a "$LOG_FILE"
    if ! bash "$temp_script" 2> >(tee -a "$ERROR_LOG") | tee -a "$LOG_FILE"; then
        local exit_code=$?
        echo -e "${RED}Error ($exit_code): OcurriÃ³ un problema durante la ejecuciÃ³n del script.${NC}" | tee -a "$LOG_FILE"
        return 1
    fi
    return 0
}

show_final_screen() {
    local status=$1
    clear
    if [ "$status" -eq 0 ]; then
        echo -e "${GREEN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
        echo -e "${GREEN}â”‚      Â¡InstalaciÃ³n completada con Ã©xito!  â”‚${NC}"
        echo -e "${GREEN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    else
        echo -e "${RED}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
        echo -e "${RED}â”‚   Â¡Error durante la instalaciÃ³n!         â”‚${NC}"
        echo -e "${RED}â”‚   Revise los archivos de registro        â”‚${NC}"
        echo -e "${RED}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    fi
    echo -e "\n${PURPLE}â™¥ï¸ SuscrÃ­bete!${NC}"
    echo -e "${PURPLE}ğŸŒ https://www.youtube.com/mxhectorvega${NC}\n"
    if [ "$status" -ne 0 ]; then
        echo -e "${YELLOW}Presione cualquier tecla para ver el log de errores...${NC}"
        read -n 1
        less "$ERROR_LOG"
    fi
    echo -e "\n${YELLOW}Presione cualquier tecla para volver al menÃº...${NC}"
    read -n 1
}

declare -A SCRIPT_URLS=(
    [1]="https://raw.githubusercontent.com/mxhectorvega/installarch/main/repos"
    [2]="https://raw.githubusercontent.com/mxhectorvega/installarch/main/flatpak"
    [3]="https://raw.githubusercontent.com/mxhectorvega/installarch/main/gnome"
    [4]="https://raw.githubusercontent.com/mxhectorvega/installarch/main/macbook"
    [5]="https://raw.githubusercontent.com/mxhectorvega/installarch/main/impresora"
    [6]="https://raw.githubusercontent.com/mxhectorvega/installarch/main/hyprland"
)

main() {
    check_requirements
    initialize_logs
    while true; do
        show_welcome
        show_menu
        read -rp $'\033[1;33mSeleccione una opciÃ³n (0-6): \033[0m' selection
        case $selection in
            0)
                echo -e "\n${YELLOW}Saliendo del instalador...${NC}"
                exit 0
                ;;
            [1-6])
                echo -e "\n${YELLOW}Ejecutando opciÃ³n $selection${NC}" | tee -a "$LOG_FILE"
                if execute_script "${SCRIPT_URLS[$selection]}"; then
                    show_final_screen 0
                else
                    show_final_screen 1
                fi
                ;;
            *)
                echo -e "\n${RED}OpciÃ³n invÃ¡lida. Por favor, seleccione un nÃºmero del 0 al 6.${NC}"
                sleep 2
                continue
                ;;
        esac
    done
}

main "$@"
#mcq
