#!/bin/sh

# Variables globales
LOG_FILE="/var/log/installarch.log"
REPO_URL="https://github.com/mxhectorvega/installarch"
CLONE_DIR="/tmp/installarch"
ROOT_PASSWORD=""
SELECTED_SCRIPT=""

# Función para verificar y satisfacer dependencias
check_dependencies() {
    local dependencies="whiptail git sudo"
    for dep in $dependencies; do
        if ! command -v "$dep" > /dev/null 2>&1; then
            echo "Instalando dependencia faltante: $dep"
            pacman -Sy --noconfirm "$dep" >> "$LOG_FILE" 2>&1
        fi
    done
}

# Función para mostrar la pantalla de bienvenida
welcome_screen() {
    whiptail --title "Bienvenido" --msgbox "Bienvenido al instalador de scripts de mxhectorvega\n\nEl archivo de registros se almacenará en: $LOG_FILE" 10 60
    if [ $? -eq 0 ]; then
        check_dependencies
        main_menu
    else
        exit 1
    fi
}

# Función para clonar el repositorio
clone_repository() {
    if [ -d "$CLONE_DIR" ]; then
        rm -rf "$CLONE_DIR"
    fi
    git clone "$REPO_URL" "$CLONE_DIR" >> "$LOG_FILE" 2>&1
}

# Función para mostrar la lista de scripts
list_scripts() {
    local scripts=$(find "$CLONE_DIR" -type f -executable ! -name "*.*" | awk -F/ '{print NR, $NF}')
    SELECTED_SCRIPT=$(whiptail --title "Lista de Scripts" --menu "Seleccione un script para ejecutar:" 20 60 10 $scripts 3>&1 1>&2 2>&3)
    if [ $? -eq 0 ]; then
        install_screen
    else
        main_menu
    fi
}

# Función para mostrar la pantalla de instalación
install_screen() {
    local script_path=$(find "$CLONE_DIR" -type f -executable ! -name "*.*" | sed -n "${SELECTED_SCRIPT}p")
    whiptail --title "Instalación" --gauge "Instalando script seleccionado..." 10 60 0 < <(
        local steps=$(wc -l < "$script_path")
        local step=0
        while IFS= read -r line; do
            step=$((step + 1))
            echo $((step * 100 / steps))
            eval "$line" >> "$LOG_FILE" 2>&1
        done < "$script_path"
    )
    if [ $? -eq 0 ]; then
        final_screen
    else
        error_screen
    fi
}

# Función para mostrar la pantalla final
final_screen() {
    whiptail --title "Finalizado" --msgbox "♥️ Suscríbete! 🌐 https://www.youtube.com/mxhectorvega" 10 60
    if [ $? -eq 0 ]; then
        if whiptail --title "Registros" --yesno "¿Desea ver el archivo de registros?" 10 60; then
            whiptail --title "Registros" --textbox "$LOG_FILE" 20 60
        fi
        cleanup
        exit 0
    else
        cleanup
        exit 1
    fi
}

# Función para mostrar la pantalla de error
error_screen() {
    whiptail --title "Error" --msgbox "La instalación ha fallado. Consulte el archivo de registros para más detalles." 10 60
    if [ $? -eq 0 ]; then
        cleanup
        exit 1
    fi
}

# Función para limpiar residuos
cleanup() {
    rm -rf "$CLONE_DIR"
}

# Función principal del menú
main_menu() {
    clone_repository
    list_scripts
}

# Inicio del script
welcome_screen
