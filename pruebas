#!/usr/bin/env bash
# Script de instalaci贸n para Arch Linux
# Autor: mxhectorvega
# Fecha: $(date +%Y-%m-%d)
# Registro de acciones en: /var/log/mxhectorvega_install.log

# Variables globales
LOGFILE="/var/log/mxhectorvega_install.log"
REPO_URL="https://github.com/mxhectorvega/installarch"
SCRIPTS_DIR="/home/$(whoami)/installarch"
DEPENDENCIAS=(dialog git awk grep find)
ROOT_PASSWORD=""
USER_NON_ROOT="$(logname)"

# Funci贸n para registrar acciones
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOGFILE"
}

# Funci贸n para comprobar e instalar dependencias
instalar_dependencias() {
    for pkg in "${DEPENDENCIAS[@]}"; do
        if ! command -v "$pkg" >/dev/null 2>&1; then
            log "Instalando dependencia: $pkg"
            pacman -Sy --noconfirm "$pkg"
        fi
    done
}

# Funci贸n para clonar el repositorio
clonar_repo() {
    if [ ! -d "$SCRIPTS_DIR" ]; then
        log "Clonando el repositorio..."
        sudo -u "$USER_NON_ROOT" git clone "$REPO_URL" "$SCRIPTS_DIR" || manejar_error "No se pudo clonar el repositorio."
    else
        log "Actualizando el repositorio..."
        (cd "$SCRIPTS_DIR" && sudo -u "$USER_NON_ROOT" git pull) || manejar_error "No se pudo actualizar el repositorio."
    fi
}

# Funci贸n de manejo de errores
manejar_error() {
    dialog --title "Error de Instalaci贸n" --msgbox "La instalaci贸n ha fallado.\nRevisa el archivo de registro en $LOGFILE para m谩s detalles." 10 60
    log "Error: $1"
    exit 1
}

# Funci贸n para solicitar la contrase帽a de root
solicitar_contrase帽a_root() {
    ROOT_PASSWORD=$(dialog --passwordbox "Por favor, ingresa tu contrase帽a de root:" 8 60 --title "Contrase帽a de Root" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        manejar_error "El usuario cancel贸 la entrada de contrase帽a."
    fi
}

# Funci贸n para mostrar la pantalla de bienvenida
pantalla_bienvenida() {
    dialog --title "Bienvenido al instalador de scripts de mxhectorvega" \
    --yes-label "Iniciar" --no-label "Cancelar" \
    --yesno "El archivo de registro se almacenar谩 en $LOGFILE\n\nSe instalar谩n las dependencias necesarias para la correcta visualizaci贸n." 10 60
    if [ $? -ne 0 ]; then
        manejar_error "El usuario cancel贸 la instalaci贸n."
    fi
}

# Funci贸n para listar y seleccionar scripts
seleccionar_script() {
    local opciones=()
    local index=1
    for script in $(find "$SCRIPTS_DIR" -type f -executable ! -name "*.*"); do
        nombre_script=$(basename "$script")
        opciones+=("$index" "$nombre_script")
        ((index++))
    done

    SCRIPT_SELECCIONADO=$(dialog --title "Lista de Scripts" --menu "Selecciona un script para ejecutar:" 20 60 10 "${opciones[@]}" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        manejar_error "El usuario cancel贸 la selecci贸n de script."
    fi

    NOMBRE_SCRIPT="${opciones[((SCRIPT_SELECCIONADO*2-1))]}"
    RUTA_SCRIPT="$SCRIPTS_DIR/$NOMBRE_SCRIPT"
}

# Funci贸n para ejecutar el script seleccionado
ejecutar_script() {
    log "Ejecutando el script: $NOMBRE_SCRIPT"
    TOTAL_PASOS=$(grep -c "^#" "$RUTA_SCRIPT")
    PASO_ACTUAL=0

    (
    while IFS= read -r linea; do
        if [[ $linea == "#"* ]]; then
            ((PASO_ACTUAL++))
            PERCENT=$((PASO_ACTUAL * 100 / TOTAL_PASOS))
            echo "XXX"
            echo $PERCENT
            echo "# $linea"
            echo "XXX"
            sleep 0.5
        else
            if [[ $linea == *"makepkg"* && $EUID -eq 0 ]]; then
                sudo -u "$USER_NON_ROOT" bash -c "$linea" >>"$LOGFILE" 2>&1 || manejar_error "Error al ejecutar makepkg: $linea"
            else
                sudo -u "$USER_NON_ROOT" bash -c "$linea" >>"$LOGFILE" 2>&1 || manejar_error "Error al ejecutar: $linea"
            fi
        fi
    done < "$RUTA_SCRIPT"
    ) | dialog --gauge "Instalando $NOMBRE_SCRIPT..." 10 60 0
}

# Funci贸n para mostrar la pantalla final
pantalla_final() {
    if dialog --title "Instalaci贸n Completa" --yes-label "Mostrar .log" --no-label "Finalizar" --yesno "わ Suscr铆bete!  https://www.youtube.com/mxhectorvega" 10 60; then
        dialog --title "Registro de Instalaci贸n" --textbox "$LOGFILE" 20 80
    fi
}

# Funci贸n para validar y verificar compatibilidad de paquetes
validar_compatibilidad() {
    # Aqu铆 puedes a帽adir la l贸gica para validar y verificar la compatibilidad de paquetes y sintaxis del instalador con los scripts clonados
    log "Validando y verificando compatibilidad de paquetes y sintaxis del instalador con los scripts clonados..."
}

# Inicio del Script
{
    instalar_dependencias
    solicitar_contrase帽a_root
    pantalla_bienvenida
    clonar_repo
    validar_compatibilidad
    seleccionar_script
    ejecutar_script
    pantalla_final
    log "Limpieza de archivos temporales."
    rm -rf "$SCRIPTS_DIR"
    log "Instalaci贸n finalizada con 茅xito."
}
