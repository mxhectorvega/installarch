#!/bin/bash

# Variables
LOG_FILE="/var/log/install_mxhectorvega.log"
REPO_URL="https://github.com/mxhectorvega/installarch"
DEPENDENCIES=("whiptail" "git")
SCRIPTS_DIR="/tmp/installarch"
USER=$(logname)

# Funciones de ayuda
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo "Este script debe ejecutarse como root" >&2
        exit 1
    fi
}

install_dependencies() {
    for dep in "${DEPENDENCIES[@]}"; do
        if ! command -v "$dep" &>/dev/null; then
            pacman -S --noconfirm "$dep"
        fi
    done
}

# Retrocompatibilidad con los scripts
validate_compatibility() {
    local script_urls=(
        "https://raw.githubusercontent.com/mxhectorvega/installarch/main/flatpak"
        "https://raw.githubusercontent.com/mxhectorvega/installarch/main/gnome"
        "https://raw.githubusercontent.com/mxhectorvega/installarch/main/repos"
        "https://raw.githubusercontent.com/mxhectorvega/installarch/main/impresora"
        "https://raw.githubusercontent.com/mxhectorvega/installarch/main/mackbook"
    )

    for url in "${script_urls[@]}"; do
        if ! curl -sSf "$url" >/dev/null; then
            log "Error: No se pudo validar la compatibilidad con $url"
            exit 1
        fi
    done
}

# Guardar contraseña de root
save_root_password() {
    if [ -z "$ROOT_PASS" ]; then
        ROOT_PASS=$(whiptail --passwordbox "Introduce la contraseña de root:" 8 60 3>&1 1>&2 2>&3)
    fi
}

# Clonar repositorio
clone_repository() {
    git clone "$REPO_URL" "$SCRIPTS_DIR"
}

# Lista de scripts ejecutables
list_scripts() {
    find "$SCRIPTS_DIR" -type f -executable -exec basename {} \; | grep -v '\.' | awk '{print NR, $0}'
}

# Progreso de instalación
install_script() {
    local script_name=$1
    su - "$USER" -c "bash $SCRIPTS_DIR/$script_name"
}

# Bienvenida
whiptail --title "Instalador de scripts de mxhectorvega" --msgbox "Bienvenido al instalador de scripts de mxhectorvega. \nLos registros se almacenarán en $LOG_FILE" 12 80

# Pantalla de lista de scripts
clone_repository
SCRIPT_LIST=$(list_scripts)
SELECTED_SCRIPT=$(whiptail --title "Lista de scripts" --menu "Selecciona un script para ejecutar:" 20 80 10 $SCRIPT_LIST 3>&1 1>&2 2>&3)

if [ -z "$SELECTED_SCRIPT" ]; then
    whiptail --title "Instalación cancelada" --msgbox "Instalación cancelada" 8 40
    exit 0
fi

# Pantalla de instalación
(
    save_root_password
    echo "10"
    echo "# Preparando la instalación..."
    sleep 1
    install_script "$SELECTED_SCRIPT"
    echo "100"
    echo "# Instalación completada"
) | whiptail --gauge "Instalando $SELECTED_SCRIPT..." 6 60 0

# Pantalla final
whiptail --title "Instalación completada" --msgbox "♥️ Suscríbete! 🌐 https://www.youtube.com/mxhectorvega" 8 80
whiptail --title "Registro de instalación" --textbox "$LOG_FILE" 20 80

# Limpieza
rm -rf "$SCRIPTS_DIR"
log "Limpieza completada"

exit 0
